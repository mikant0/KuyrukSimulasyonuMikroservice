<!doctype html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Kuyruk İzleme (Web)</title>
    <style>
        body {
            font-family: system-ui,Arial,sans-serif;
            max-width: 1000px;
            margin: 24px auto;
            padding: 0 12px
        }

        h1 {
            margin: 0 0 16px
        }

        .row {
            display: grid;
            grid-template-columns: repeat(2, minmax(240px,1fr));
            gap: 12px
        }

        label {
            display: flex;
            flex-direction: column;
            font-size: 14px;
            gap: 6px
        }

        input {
            padding: 8px;
            border: 1px solid #d0d7de;
            border-radius: 8px
        }

        button {
            padding: 10px 14px;
            border: 0;
            border-radius: 10px;
            background: #0969da;
            color: #fff;
            cursor: pointer
        }

            button.secondary {
                background: #6e7781
            }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 18px
        }

        th, td {
            border: 1px solid #e5e7eb;
            padding: 8px;
            text-align: left
        }

        th {
            background: #f8fafc
        }

        .hint {
            font-size: 12px;
            color: #6e7781;
            margin-top: 6px
        }

        .status {
            margin-top: 12px
        }

        .ok {
            color: #1a7f37
        }

        .err {
            color: #cf222e
        }
    </style>
</head>
<body>
    <h1>Kuyruk Kayıtları</h1>

    <div class="row">
        <label>
            Server
            <input id="server" value="(localdb)\\MSSQLLocalDB" />
        </label>
        <label>
            Database
            <input id="database" value="KuyrukDB" />
        </label>
        <label>
            User Id
            <input id="userId" value="" placeholder="LocalDB için boş bırakın" />
            <span class="hint">LocalDB: Windows oturumunu kullanır (boş bırakın)</span>
        </label>
        <label>
            Password
            <input id="password" type="password" value="" />
        </label>
        <label>
            Table
            <input id="table" value="KuyrukKaydi" />
        </label>
    </div>

    <div style="margin-top:14px; display:flex; gap:10px;">
        <button id="btnLoad">Verileri Getir (DB)</button>
        <button class="secondary" id="btnSample">Örnek Veriyi Getir (API)</button>
        <button class="secondary" id="btnPing">Ping</button>
    </div>

    <div class="status" id="status"></div>

    <table id="grid" style="display:none">
        <thead>
            <tr><th>PointId</th><th>Timestamp</th><th>Duration (min)</th></tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
    const statusEl = document.getElementById('status');
    const grid = document.getElementById('grid');
    const tbody = grid.querySelector('tbody');

    function setStatus(msg, ok=true){
      statusEl.innerHTML = `<span class="${ok ? 'ok':'err'}">${msg}</span>`;
    }

    function readForm(){
      return {
        server:   document.getElementById('server').value,
        database: document.getElementById('database').value,
        userId:   document.getElementById('userId').value,
        password: document.getElementById('password').value,
        table:    document.getElementById('table').value
      };
    }

    function render(rows){
      tbody.innerHTML = '';
      if(!Array.isArray(rows)){ setStatus('Beklenmeyen cevap', false); return; }
      for(const r of rows){
        const tr = document.createElement('tr');
        const pid = r.pointId ?? r.PointId;
        const ts  = new Date(r.timestamp ?? r.Timestamp).toLocaleString();
        const dur = r.durationMin ?? r.DurationMin;
        tr.innerHTML = `<td>${pid}</td><td>${ts}</td><td>${dur}</td>`;
        tbody.appendChild(tr);
      }
      grid.style.display = rows.length ? 'table' : 'none';
      setStatus(`Toplam ${rows.length} kayıt yüklendi.`);
    }

    document.getElementById('btnLoad').onclick = async () => {
      setStatus('Yükleniyor...');
      try{
        const body = readForm();
        const res = await fetch('/api/kuyruk/query', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if(!res.ok){ setStatus(data.error || JSON.stringify(data), false); return; }
        render(data);
      }catch(err){
        setStatus(err.message || String(err), false);
      }
    };

    document.getElementById('btnSample').onclick = async () => {
      setStatus('Örnek veri alınıyor...');
      const res = await fetch('/api/kuyruk/sample');
      const data = await res.json();
      render(data);
    };

    document.getElementById('btnPing').onclick = async () => {
      const res = await fetch('/api/kuyruk/ping');
      const data = await res.json();
      setStatus(`Ping OK: ${data.time}`, true);
    };
    </script>
</body>
</html>
