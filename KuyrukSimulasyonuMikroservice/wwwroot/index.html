<!doctype html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <title>Kuyruk Kayıtları</title>
    <style>
        body {
            font-family: system-ui,Arial,sans-serif;
            max-width: 1000px;
            margin: 24px auto;
            padding: 0 12px
        }

        .row {
            display: grid;
            grid-template-columns: repeat(2,minmax(240px,1fr));
            gap: 12px
        }

        label {
            display: flex;
            flex-direction: column;
            gap: 6px
        }

        input {
            padding: 8px;
            border: 1px solid #d0d7de;
            border-radius: 8px
        }

        button {
            padding: 10px 14px;
            border: 0;
            border-radius: 10px;
            background: #0969da;
            color: #fff;
            cursor: pointer
        }

            button.secondary {
                background: #6e7781
            }

            button[disabled] {
                opacity: .6;
                cursor: not-allowed
            }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 18px
        }

        th, td {
            border: 1px solid #e5e7eb;
            padding: 8px;
            text-align: left
        }

        th {
            background: #f8fafc
        }

        .hint {
            font-size: 12px;
            color: #6e7781
        }

        .status {
            margin-top: 12px
        }

        .ok {
            color: #1a7f37
        }

        .err {
            color: #cf222e
        }
    </style>
</head>
<body>
    <h1>Kuyruk Kayıtları</h1>

    <div class="row">
        <label>
            Server
            <input id="server" value="(localdb)\MSSQLLocalDB">
        </label>
        <label>
            Database
            <input id="database" value="KuyrukDB">
        </label>
        <label>
            User Id
            <input id="userId" value="" 
        </label>
        <label>
            Password
            <input id="password" type="password" value="">
        </label>
        <label>
            Table
            <input id="table" value="KuyrukKaydi">
        </label>
    </div>

    <div style="margin-top:14px;display:flex;gap:10px;">
        <button id="btnLoad">Verileri Getir (DB)</button>
        <button class="secondary" id="btnSample">Örnek Veriyi Getir (API)</button>
        <button class="secondary" id="btnPing">Ping</button>
    </div>

    <div class="status" id="status"></div>

    <table id="grid" style="display:none">
        <thead><tr><th>PointId</th><th>Timestamp</th><th>Duration (min)</th></tr></thead>
        <tbody></tbody>
    </table>

    <script>
        const statusEl = document.getElementById('status');
        const grid = document.getElementById('grid');
        const tbody = grid.querySelector('tbody');

        function setStatus(msg, ok = true) {
            statusEl.innerHTML = `<span class="${ok ? 'ok' : 'err'}">${msg}</span>`;
        }

        const btnLoad = document.getElementById('btnLoad');
        const btnSample = document.getElementById('btnSample');
        const btnPing = document.getElementById('btnPing');

        function readForm() {
            const v = id => document.getElementById(id).value.trim();
            let table = v('table');
            // tablo boşsa veya şemasızsa dbo ile tamamla
            if (!table) table = 'dbo.KuyrukKaydi';
            else if (!table.includes('.')) table = `dbo.${table}`;
            return {
                server: v('server'),
                database: v('database'),
                userId: v('userId'),
                password: v('password'),
                table
            };
        }

        function render(rows) {
            tbody.innerHTML = '';
            if (!Array.isArray(rows)) { setStatus('Beklenmeyen cevap', false); return; }
            rows.forEach(r => {
                const tr = document.createElement('tr');
                const pid = r.pointId ?? r.PointId ?? '';
                const rawTs = r.timestamp ?? r.Timestamp;
                const ts = rawTs ? new Date(rawTs).toLocaleString() : '';
                const dur = r.durationMin ?? r.DurationMin ?? '';
                tr.innerHTML = `<td>${pid}</td><td>${ts}</td><td>${dur}</td>`;
                tbody.appendChild(tr);
            });
            grid.style.display = rows.length ? 'table' : 'none';
            setStatus(`Toplam ${rows.length} kayıt yüklendi.`, true);
        }

        async function safeJson(res) {
            // sunucu bazen metin döndürebilir; önce ham al
            const raw = await res.text();
            if (!res.ok) throw new Error(raw || `HTTP ${res.status}`);
            if (!raw) return [];
            try { return JSON.parse(raw); }
            catch { throw new Error('Gelen cevap JSON değil: ' + raw.slice(0, 200)); }
        }

        async function withBusy(btn, fn) {
            try { btn.disabled = true; await fn(); }
            finally { btn.disabled = false; }
        }

        btnLoad.onclick = () => withBusy(btnLoad, async () => {
            setStatus('Yükleniyor...');
            const body = readForm();
            const res = await fetch('/api/Kuyruk/query', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const data = await safeJson(res);
            render(data);
        });

        btnSample.onclick = () => withBusy(btnSample, async () => {
            setStatus('Örnek veri alınıyor...');
            const res = await fetch('/api/Kuyruk/sample');
            const data = await safeJson(res);
            render(data);
        });

        btnPing.onclick = () => withBusy(btnPing, async () => {
            const res = await fetch('/api/Kuyruk/ping');
            const data = await safeJson(res);
            setStatus(`Ping OK: ${data.time}`, true);
        });
    </script>
</body>
</html>

