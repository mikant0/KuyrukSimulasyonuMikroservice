<!doctype html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <title>Kuyruk Kayıtları</title>
    <style>
        body {
            font-family: system-ui, Arial, sans-serif;
            max-width: 1000px;
            margin: 24px auto;
            padding: 0 12px;
        }

        .row {
            display: grid;
            grid-template-columns: repeat(2, minmax(240px, 1fr));
            gap: 12px;
        }

        label {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        input {
            padding: 8px;
            border: 1px solid #d0d7de;
            border-radius: 8px;
        }

        button {
            padding: 10px 14px;
            border: 0;
            border-radius: 10px;
            background: #0969da;
            color: #fff;
            cursor: pointer;
        }

            button.secondary {
                background: #6e7781;
            }

            button.danger {
                background: #d12c2c;
            }

            button[disabled] {
                opacity: .6;
                cursor: not-allowed;
            }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 18px;
        }

        th, td {
            border: 1px solid #e5e7eb;
            padding: 8px;
            text-align: left;
        }

        th {
            background: #f8fafc;
        }

        tr:hover {
            background-color: #f1f5f9;
            cursor: pointer;
        }

        .hint {
            font-size: 12px;
            color: #6e7781;
        }

        .status {
            margin-top: 12px;
        }

        .ok {
            color: #1a7f37;
        }

        .err {
            color: #cf222e;
        }

        h2 {
            margin-top: 24px;
        }
    </style>
</head>
<body>
    <h1>Kuyruk Kayıtları</h1>

    <!-- bağlantı bilgileri -->
    <div class="row">
        <label>Server <input id="server" value="(localdb)\MSSQLLocalDB"></label>
        <label>Database <input id="database" value="KuyrukDB"></label>
        <label>User Id <input id="userId" value=""></label>
        <label>Password <input id="password" type="password" value=""></label>
        <label>Table <input id="table" value="KuyrukKaydi"></label>
    </div>

    <div style="margin-top:14px;display:flex;gap:10px;">
        <button id="btnLoad">Verileri Getir (DB)</button>
        <button class="secondary" id="btnSample">Örnek Veriyi Getir (API)</button>
        <button class="secondary" id="btnPing">Ping</button>
    </div>

    <div class="status" id="status"></div>

    <!-- tablo -->
    <table id="grid" style="display:none">
        <thead><tr><th>Id</th><th>PointId</th><th>Timestamp</th><th>Duration (min)</th></tr></thead>
        <tbody></tbody>
    </table>

    <!-- kayıt formu -->
    <h2>Yeni / Seçilen Kayıt</h2>
    <div class="row">
        <label>
            Id (otomatik)
            <input id="f_id" disabled>
        </label>
        <label>
            Point Id
            <input id="f_pointid">
        </label>
        <label>
            Timestamp
            <input id="f_timestamp" type="datetime-local">
        </label>
        <label>
            Duration (dakika)
            <input id="f_duration" type="number">
        </label>
    </div>

    <div style="margin-top:14px;display:flex;gap:10px;">
        <button id="btnAdd">Yeni Kayıt Ekle</button>
        <button class="danger" id="btnDelete">Seçili Kaydı Sil</button>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const grid = document.getElementById('grid');
        const tbody = grid.querySelector('tbody');
        const btnLoad = document.getElementById('btnLoad');
        const btnSample = document.getElementById('btnSample');
        const btnPing = document.getElementById('btnPing');
        const btnAdd = document.getElementById('btnAdd');
        const btnDelete = document.getElementById('btnDelete');

        let selectedId = null;

        function setStatus(msg, ok = true) {
            statusEl.innerHTML = `<span class="${ok ? 'ok' : 'err'}">${msg}</span>`;
        }

        function readForm() {
            const v = id => document.getElementById(id).value.trim();
            let table = v('table');
            if (!table) table = 'dbo.KuyrukKaydi';
            else if (!table.includes('.')) table = `dbo.${table}`;
            return {
                server: v('server'),
                database: v('database'),
                userId: v('userId'),
                password: v('password'),
                table
            };
        }

        async function safeJson(res) {
            const raw = await res.text();
            if (!res.ok) throw new Error(raw || `HTTP ${res.status}`);
            if (!raw) return [];
            try { return JSON.parse(raw); }
            catch { throw new Error('Gelen cevap JSON değil: ' + raw.slice(0, 200)); }
        }

        async function withBusy(btn, fn) {
            try { btn.disabled = true; await fn(); }
            finally { btn.disabled = false; }
        }

        function render(rows) {
            tbody.innerHTML = '';
            if (!Array.isArray(rows)) { setStatus('Beklenmeyen cevap', false); return; }
            rows.forEach(r => {
                const tr = document.createElement('tr');
                const id = r.id ?? r.Id ?? '';
                const pid = r.pointId ?? r.PointId ?? '';
                const rawTs = r.timestamp ?? r.Timestamp;
                const ts = rawTs ? new Date(rawTs).toLocaleString() : '';
                const dur = r.durationMin ?? r.DurationMin ?? '';
                tr.innerHTML = `<td>${id}</td><td>${pid}</td><td>${ts}</td><td>${dur}</td>`;
                tr.onclick = () => selectRow(id, pid, rawTs, dur);
                tbody.appendChild(tr);
            });
            grid.style.display = rows.length ? 'table' : 'none';
            setStatus(`Toplam ${rows.length} kayıt yüklendi.`, true);
        }

        function selectRow(id, pid, ts, dur) {
            selectedId = id;
            document.getElementById('f_id').value = id;
            document.getElementById('f_pointid').value = pid;
            document.getElementById('f_timestamp').value = ts ? ts.slice(0, 16) : '';
            document.getElementById('f_duration').value = dur;
            setStatus(`ID ${id} seçildi.`, true);
        }

        btnLoad.onclick = () => withBusy(btnLoad, async () => {
            setStatus('Yükleniyor...');
            const body = readForm();
            try {
                const res = await fetch('/api/kuyruk/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await safeJson(res);
                console.log("Gelen veri:", data);
                render(data);
            } catch (err) {
                console.error("Hata:", err);
                setStatus('Hata oluştu: ' + err.message, false);
            }
        });


        btnSample.onclick = () => withBusy(btnSample, async () => {
            setStatus('Örnek veri alınıyor...');
            const res = await fetch('/api/kuyruk/sample');
            const data = await safeJson(res);
            render(data);
        });

        btnPing.onclick = () => withBusy(btnPing, async () => {
            const res = await fetch('/api/kuyruk/ping');
            const data = await safeJson(res);
            setStatus(`Ping OK: ${data.time}`, true);
        });

        btnAdd.onclick = () => withBusy(btnAdd, async () => {
            const conn = readForm();
            const rec = {
                PointId: document.getElementById('f_pointid').value.trim(),
                Timestamp: document.getElementById('f_timestamp').value,
                DurationMin: parseInt(document.getElementById('f_duration').value)
            };
            if (!rec.PointId || !rec.Timestamp || !rec.DurationMin) {
                setStatus('Lütfen tüm alanları doldurun.', false);
                return;
            }
            const res = await fetch('/api/kuyruk/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...conn, record: rec })
            });
            const data = await safeJson(res);
            setStatus(data.message || 'Kayıt eklendi.');
            btnLoad.click();
        });

        btnDelete.onclick = () => withBusy(btnDelete, async () => {
            if (!selectedId) { setStatus('Önce silinecek bir kayıt seçin.', false); return; }
            const conn = readForm();
            const res = await fetch('/api/kuyruk/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...conn, id: selectedId })
            });
            const data = await safeJson(res);
            setStatus(data.message || 'Kayıt silindi.');
            selectedId = null;
            btnLoad.click();
        });
    </script>
</body>
</html>
